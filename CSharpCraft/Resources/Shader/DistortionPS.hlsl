// =====================================================
// 定数バッファ（C# 側から毎フレーム更新される）
// register(b4) は C# の SetShaderConstantBuffer(..., 4) と対応
// =====================================================
cbuffer CB : register(b4)
{
    // 経過時間（秒 or フレーム基準）
    // 波のアニメーションを時間で動かすために使用
    float time;
    
    // 描画解像度（width, height）
    // UV → ピクセル変換や歪み量の正規化に使用
    float2 resolution;
    
    // 歪みを適用する矩形エリア（画面ピクセル座標）
    // areaMin 〜 areaMax の範囲内だけ歪ませる
    float areaMinX;
    float areaMaxX;
    float areaMinY;
    float areaMaxY;
    
    // 歪みの強さ
    // 0.0 = 歪みなし
    // 1.0〜 = 徐々に強調される
    float distortPower; // ★ 追加：0.0 〜 大きい値
};

// =====================================================
// 入力テクスチャ（シーン全体を描画したスクリーン）
// =====================================================
Texture2D tex0 : register(t0);
SamplerState sam0 : register(s0);

// =====================================================
// ピクセルシェーダ入力構造体
// =====================================================
struct PS_INPUT
{
    // スクリーン座標（ピクセル単位）
    float4 pos : SV_POSITION;
    
    // 頂点カラー（今回は未使用だが拡張用）
    float4 color : COLOR0;
    
    // UV 座標（0.0〜1.0）
    float2 uv : TEXCOORD0;
};

// =====================================================
// ピクセルシェーダ本体
// =====================================================
float4 main(PS_INPUT input) : SV_TARGET
{
    // -------------------------------------------------
    // 歪み対象エリア内か判定
    // pos.x / pos.y は画面ピクセル座標
    // -------------------------------------------------
    if ((areaMinX < input.pos.x && input.pos.x < areaMaxX) &&
        (areaMinY < input.pos.y && input.pos.y < areaMaxY))
    {
        // ---------------------------------------------
        // UV の Y をピクセル座標に変換
        // 縦方向の位置によって歪み方を変えるため
        // ---------------------------------------------
        float y = input.uv.y * resolution.y;
    
        // ---------------------------------------------
        // 波形計算（C# 側のロジックをそのまま移植）
        //
        // ・sin を2種類合成して自然な歪みを作る
        // ・周波数が違う波を重ねることで単調さを回避
        // ---------------------------------------------
        float wave =
            sin((y * 0.15) + time * 6.0) * 8.0 + // 細かく速い波
            sin((y * 0.05) + time * 3.0) * 4.0; // ゆっくり大きな波
    
        // ---------------------------------------------
        // 歪み強度を外部パラメータで調整
        // FadeIn / FadeOut などに使用可能
        // --------------------------------------------
        wave *= distortPower;
        
        // ---------------------------------------------
        // UV 座標を歪ませる
        // wave はピクセル量なので解像度で割って UV 化
        // 横方向（X）のみを歪ませて水面・熱揺らぎ風に
        // ---------------------------------------------
        float2 uv = input.uv;
        uv.x += wave / resolution.x;
    
        // 歪ませた UV でテクスチャサンプリング
        return tex0.Sample(sam0, uv);
    }
    else
    {
        // -------------------------------------------------
        // 対象エリア外はそのまま描画（歪みなし）
        // -------------------------------------------------
        return tex0.Sample(sam0, input.uv);
    }
}
